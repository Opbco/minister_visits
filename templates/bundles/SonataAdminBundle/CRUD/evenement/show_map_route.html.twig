{# templates/admin/evenement/show_map_route.html.twig #}
{% extends '@SonataAdmin/CRUD/base_show_field.html.twig' %}
{% block field %}
    <div class="box box-primary">
        <div class="box-header with-border">
            <h3 class="box-title"><i class="fa fa-map-marker"></i> Itinéraire de la visite</h3>
        </div>
        <div class="box-body">
            {# Container for the map #}
            <div id="event-map" style="height: 500px; width: 100%; border-radius: 4px;"></div>
            <div class="mt-2 text-muted">
                <small><i class="fa fa-info-circle"></i> La ligne bleue représente l'ordre chronologique des visites.</small>
            </div>
        </div>
    </div>

    {# Leaflet Dependencies #}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        jQuery(document).ready(function($) {
            // 1. Prepare Data from Twig to JS
            // We sort visits by dateArrivee to ensure the route line makes sense
            var visits = [
            {% for visite in object.visites|sort((a, b) => a.dateArrivee <=> b.dateArrivee) %}
                {% if visite.structure and visite.structure.latitude and visite.structure.longitude %}
                    {
                        name: "{{ visite.structure.nameFr|e('js') }}",
                        acronym: "{{ visite.structure.acronym|default('')|e('js') }}",
                        date: "{{ visite.dateArrivee|date('d/m/Y H:i') }}",
                        lat: {{ visite.structure.latitude }},
                        lng: {{ visite.structure.longitude }}
                    },
                {% endif %}
            {% endfor %}
            ];

            // If no visits with coordinates, show default map of Yaoundé
            if (visits.length === 0) {
            var map = L.map('event-map').setView([3.8480, 11.5021], 6);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                return;
            }

            // 2. Initialize Map
            var map = L.map('event-map');
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var markers = [];
            var latLngs = [];

            // 3. Loop through data to add Markers and Lines
            $.each(visits, function(index, visit) {
                var point = [visit.lat, visit.lng];
                latLngs.push(point);

                var marker = L.marker(point).addTo(map);
                var popupContent = `
                    <strong>${index + 1}. ${visit.name}</strong> ${visit.acronym ? '('+visit.acronym+')' : ''}<br>
                    <span class="text-muted"><i class="fa fa-clock-o"></i> ${visit.date}</span>
                `;
                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            // 4. Draw Polyline
            if (latLngs.length > 1) {
                L.polyline(latLngs, {
                    color: '#3c8dbc',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10',
                    lineCap: 'round'
                }).addTo(map);
            }

            // 5. Fit Bounds
            var group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));

            // Fix map rendering in tabs
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                map.invalidateSize();
                map.fitBounds(group.getBounds().pad(0.1));
            });
        });
    </script>
{% endblock %}