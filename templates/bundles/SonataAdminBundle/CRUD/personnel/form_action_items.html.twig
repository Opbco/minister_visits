{# templates/admin/personnel/form_action_items.html.twig #}
{% set totalActions = form.vars.value.actionItems|length %}
{% set completedActions = form.vars.value.actionItems|filter(item => item.statut.value == 'completed')|length %}
{% set pendingActions = form.vars.value.actionItems|filter(item => item.statut.value == 'pending')|length %}
{% set inProgressActions = form.vars.value.actionItems|filter(item => item.statut.value == 'in_progress')|length %}
{% set overdueActions = form.vars.value.actionItems|filter(item => item.dateEcheance and item.dateEcheance < date() and item.statut.value != 'completed')|length %}

<div class="row">
    <div class="col-md-3">
        <div class="small-box bg-blue">
            <div class="inner">
                <h3>{{ totalActions }}</h3>
                <p>Total Actions</p>
            </div>
            <div class="icon">
                <i class="fa fa-tasks"></i>
            </div>
            <a href="{{ admin.generateObjectUrl('action_items', form.vars.value) }}" class="small-box-footer">
                View all <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <div class="col-md-3">
        <div class="small-box bg-yellow">
            <div class="inner">
                <h3>{{ pendingActions }}</h3>
                <p>Pending</p>
            </div>
            <div class="icon">
                <i class="fa fa-hourglass-half"></i>
            </div>
            <div class="small-box-footer">
                Awaiting action
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="small-box bg-green">
            <div class="inner">
                <h3>{{ completedActions }}</h3>
                <p>Completed</p>
            </div>
            <div class="icon">
                <i class="fa fa-check-circle"></i>
            </div>
            <div class="small-box-footer">
                {{ totalActions > 0 ? ((completedActions / totalActions * 100)|round) : 0 }}% completion rate
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="small-box {% if overdueActions > 0 %}bg-red{% else %}bg-gray{% endif %}">
            <div class="inner">
                <h3>{{ overdueActions }}</h3>
                <p>Overdue</p>
            </div>
            <div class="icon">
                <i class="fa fa-warning"></i>
            </div>
            <div class="small-box-footer">
                {% if overdueActions > 0 %}
                    <strong>Requires attention!</strong>
                {% else %}
                    No overdue items
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if totalActions > 0 %}
    <div class="box box-warning">
        <div class="box-header with-border">
            <h3 class="box-title">Recent Action Items (Last 10)</h3>
        </div>
        <div class="box-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th width="40%">Action</th>
                        <th>Meeting</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in form.vars.value.actionItems|slice(0, 10) %}
                        <tr class="{% if item.dateEcheance and item.dateEcheance < date() and item.statut.value != 'completed' %}danger{% endif %}">
                            <td>
                                <strong>{{ item.description|slice(0, 80) }}{% if item.description|length > 80 %}...{% endif %}</strong>
                                {% if item.commentaire %}
                                    <br><small class="text-muted">
                                        <i class="fa fa-comment"></i> {{ item.commentaire|slice(0, 50) }}
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    <i class="fa fa-calendar"></i>
                                    {{ item.reunion.objet|slice(0, 40) }}{% if item.reunion.objet|length > 40 %}...{% endif %}
                                    <br>
                                    <span class="text-muted">{{ item.reunion.dateDebut|date('d/m/Y') }}</span>
                                </small>
                            </td>
                            <td>
                                {% if item.dateEcheance %}
                                    <i class="fa fa-clock-o"></i>
                                    {{ item.dateEcheance|date('d/m/Y') }}
                                    {% if item.dateEcheance < date() and item.statut.value != 'completed' %}
                                        <br><span class="label label-danger">
                                            <i class="fa fa-warning"></i> Overdue
                                        </span>
                                    {% elseif item.dateEcheance < date('+7 days') and item.statut.value != 'completed' %}
                                        <br><span class="label label-warning">
                                            <i class="fa fa-clock-o"></i> Due soon
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">No deadline</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set status = item.statut.value %}
                                {% if status == 'completed' %}
                                    <span class="label label-success">
                                        <i class="fa fa-check"></i> Completed
                                    </span>
                                {% elseif status == 'in_progress' %}
                                    <span class="label label-info">
                                        <i class="fa fa-spinner"></i> In Progress
                                    </span>
                                {% elseif status == 'cancelled' %}
                                    <span class="label label-default">
                                        <i class="fa fa-ban"></i> Cancelled
                                    </span>
                                {% else %}
                                    <span class="label label-warning">
                                        <i class="fa fa-hourglass"></i> Pending
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-xs btn-default" 
                                            onclick="viewActionItem({{ item.id }})" 
                                            title="View details">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if overdueActions > 0 %}
        <div class="alert alert-danger">
            <i class="fa fa-warning"></i> <strong>Alert:</strong> 
            This person has {{ overdueActions }} overdue action item{{ overdueActions > 1 ? 's' : '' }} that require{{ overdueActions == 1 ? 's' : '' }} immediate attention.
        </div>
    {% endif %}
{% else %}
    <div class="alert alert-info">
        <i class="fa fa-info-circle"></i> <strong>No action items yet.</strong>
        This person has not been assigned any action items from meetings.
    </div>
{% endif %}

<script>
function viewActionItem(id) {
    // This would typically open a modal or redirect to the action item detail page
    alert('View action item #' + id);
    // In real implementation:
    window.location.href = '/admin/app/actionitem/' + id + '/show';
}